name: Run Tests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: 8.1
            testbench: "^8.0"
          - php: 8.2
            testbench: "^9.0" 
          - php: 8.3
            testbench: "^10.0"
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          
      - name: Install dependencies
        run: |
          composer require --dev orchestra/testbench:${{ matrix.testbench }} --no-update
          composer install --prefer-dist --no-interaction --no-progress
          
      - name: Debug - Full file structure
        run: |
          echo "=== Working directory ==="
          pwd
          echo "=== All files ==="
          find . -type f -name "*.php" -o -name "*.xml" -o -name "*.json"
          echo "=== PHPUnit config ==="
          cat phpunit.xml 2>/dev/null || echo "No phpunit.xml found"
          echo "=== Test file content ==="
          cat tests/CookieHttpTest.php 2>/dev/null || echo "No test file found"
          echo "=== Composer autoload ==="
          cat vendor/composer/autoload_psr4.php | grep -A5 -B5 "CookieHttp" || echo "No autoload found"
          
      - name: Check PHP syntax
        run: |
          echo "=== Checking PHP syntax ==="
          find tests -name "*.php" -exec php -l {} \; || echo "Syntax errors found"
          
      - name: PHPUnit version and config
        run: |
          echo "=== PHPUnit version ==="
          vendor/bin/phpunit --version
          echo "=== PHPUnit configuration check ==="
          vendor/bin/phpunit --configuration phpunit.xml --list-tests-xml || echo "Configuration error"
          
      - name: Try to list tests
        run: |
          echo "=== Attempting to list tests ==="
          vendor/bin/phpunit --list-tests || echo "Failed to list tests - exit code: $?"
          
      - name: Run PHPUnit with maximum verbosity
        run: vendor/bin/phpunit --debug --verbose